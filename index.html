<!DOCTYPE html>
<meta charset="utf-8">
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://zurb.com/playground/uploads/upload/upload/330/stackblur.min.js"></script>
<link rel="stylesheet" href="styles.css" />
<img id="my-img" src="./imgs/scott.jpg"></img>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
    // Global variables
    var height = 500;
    var width = 500;

    var sites = d3.range(3000)
        .map(function(d) {
            return [Math.random() * width, Math.random() * height];
        });


    // Select image
    var img = document.getElementById('my-img');
    img.height = height;
    img.width = width;

    // Canvases
    var canvases = [
        // {
        //     id: 'normal',
        //     className: 'normal'
        // },
        // {
        //     id: 'triagled',
        //     className: 'triangled'
        // },
        {
            id: 'triangleBlur',
            className: 'triangleBlur'
        },
        {
            id: 'heroCanvas',
            className: 'hero'
        },
    ];
    var makeCanvas = function(can) {
        var canvas = document.createElement('canvas');
        canvas.id = can.id;
        canvas.className += can.className;
        canvas.width = width;
        canvas.height = height;
        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
        document.body.appendChild(canvas);
    }
    // makeImage(canvas);
    // makeImage(clearCanvas);
    canvases.forEach(makeCanvas)

    // Blur
    // Change this value to adjust the amount of blur
    var blurCanvas = document.getElementById('heroCanvas');
    var BLUR_RADIUS = 10;
    var canvasContext = blurCanvas.getContext('2d');
    var drawBlur = function() {
        canvasContext.drawImage(blurCanvas, 0, 0, width, height);
        stackBlurCanvasRGBA('heroCanvas', 0, 0, width, height, BLUR_RADIUS);
    };
    drawBlur()

    var drawPath = function(tri, can) {
        console.log('canvas id', can)
        var canvas = document.getElementById(can);
        console.log('canvas ', canvas)
        tri
            .classed("primary", function(d) {
                return d[0] === sites[0] || d[1] === sites[0] || d[2] === sites[0];
            })
            .attr("d", function(d) {
                return "M" + d.join("L") + "Z";
            })
            .style("fill", function(d) {
                var x = 0;
                var y = 0;
                d.forEach(function(dd) {
                    x += dd[0];
                    y += dd[1];
                })
                x = x / 3;
                y = y / 3;
                var pixelData = canvas.getContext('2d').getImageData(x, y, 1, 1).data;
                return 'rgba(' + pixelData.toString() + ')';
            })
            .style('stroke-opacity', '.2')
    }
    drawTriangle = function(can) {
        var svg = d3.select('body')
            .append("svg")
            .attr('width', width)
            .attr('height', height);
        console.log("svg", svg)

        var voronoi = d3.voronoi();

        var triangle = svg.append("g")
            .attr("class", "triangles")
            .selectAll("path")
            .data(voronoi.triangles(sites))
            .enter().append("path")
            .call(drawPath, can.id);
    }
    // setTimeout(function() {
    canvases.map(drawTriangle)

    // }, 1000)
</script>